#!/bin/bash
# Example call:
# OUT_LOG=/tmp/output.log ERR_LOG=/tmp/err.log azkaban-web-server

# Specifies location of azkaban.properties, log4j.properties files
# Change if necessary
conf=/etc/azkaban-web-server
plugins=$conf/plugins
libs=/usr/lib/azkaban-web-server

if [[ -z "$tmpdir" ]]; then
	tmpdir=/tmp
fi

for file in $libs/*.jar;
do
	CLASSPATH=$CLASSPATH:$file
done

for file in $libs/extlib/*.jar;
do
	CLASSPATH=$CLASSPATH:$file
done

for file in $plugins/*/*.jar;
do
	CLASSPATH=$CLASSPATH:$file
done

if [ "$HADOOP_HOME" != "" ]; then
	echo "Using Hadoop from $HADOOP_HOME"
	CLASSPATH=$CLASSPATH:$HADOOP_HOME/conf:$HADOOP_HOME/*
	JAVA_LIB_PATH="-Djava.library.path=$HADOOP_HOME/lib/native/Linux-amd64-64"
else
	echo "Error: HADOOP_HOME is not set. Hadoop job types will not run properly."
	# Must have log4j.properties ..
	CLASSPATH=$CLASSPATH:$conf
fi

if [ "$HIVE_HOME" != "" ]; then
	echo "Using Hive from $HIVE_HOME"
	CLASSPATH=$CLASSPATH:$HIVE_HOME/conf:$HIVE_HOME/lib/*
fi

executorport=`cat $conf/azkaban.properties | grep executor.port | cut -d = -f 2`
jettyport=`cat $conf/azkaban.properties | grep jetty.port | cut -d = -f 2`
jettyssl=`cat $conf/azkaban.properties | grep jetty.use.ssl | cut -d = -f 2`
if test $jettyssl = "false"; then
    webprotocol="http://"
else
    webprotocol="https://"
    jettyport=`cat $conf/azkaban.properties | grep jetty.ssl.port | cut -d = -f 2`
fi
serverpath=/var/lib/azkaban-web-server
logdir=/var/log/azkaban-web-server

if test -z "$OUT_LOG"; then
	OUT_LOG=$logdir/output.log
fi

if test -z "$ERR_LOG"; then
	ERR_LOG=$logdir/error.log
fi

if [ -z $AZKABAN_OPTS ]; then
	AZKABAN_OPTS=-Xmx3G
fi
# Set the log4j configuration file
if [ -f $conf/log4j.properties ]; then
	AZKABAN_OPTS="$AZKABAN_OPTS -Dlog4j.configuration=file:$conf/log4j.properties"
fi
AZKABAN_OPTS="$AZKABAN_OPTS -server -Dcom.sun.management.jmxremote -Djava.io.tmpdir=$tmpdir -Dexecutorport=$executorport -Dserverpath=$serverpath -Dlog4j.log.dir=$logdir"

java -version 2>&1 | egrep -o "build 1\.[891]" >/dev/null

if test $? -ne 0; then
	echo "Java must run in version 8 and higher!" >&2
	echo "On debian distro you can run:" >&2
	echo " update-alternatives --config java" >&2
	exit 2
fi

echo "Running the web server on port $jettyport"
echo "Logging dir: $logdir"

cd $serverpath
java $AZKABAN_OPTS $JAVA_LIB_PATH -cp $CLASSPATH azkaban.webapp.AzkabanWebServer -conf $conf $@ >>$OUT_LOG 2>>$ERR_LOG &

PID=$!

echo "looking for PID $PID"

# Sleep for a few seconds & check process is still running
timeout 2 tail -f "$ERR_LOG"
if test -z "`ps x | grep $PID | grep -v "grep $PID"`"; then
	echo "ERROR: Server start failed!" >&2
	echo -e "Serverpath: $serverpath\n" >&2
	#tail $ERR_LOG >&2
	exit 1
fi

echo $PID > /var/run/azkaban-web-server/currentpid

echo "Server started successfully"
echo "PID: $PID"
echo
echo "You can visit the azkaban-web-server at $webprotocol`hostname`:$jettyport"
